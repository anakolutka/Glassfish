<?xml version="1.0"?>

<!DOCTYPE project [
<!ENTITY commonBuild SYSTEM "file:./../annotations-common.xml">
]>

<project name="Hello" default="core" basedir=".">
 

    &commonBuild;
    <property name="src-name" value="endpoint/WebServiceEJB.java"/>
    <property name="client-src-name" value="client/Client.java"/>

    <target name="all" depends="clean, deploy, private-run, private-undeploy, report"/>


    <target name="private-undeploy">
	<antcall target="autoundeploy-file">
		<param name="filename" value="EjbClient.jar"/>
	</antcall>
	<antcall target="autoundeploy-file">
		<param name="filename" value="WebServiceEJB.jar"/>
	</antcall>
    </target>


    <target name="private-run">
	<antcall target="clean"/>
        <echo message="wsimporting http://${http.host}:${http.port}/WebServiceEJBService/WebServiceEJB?WSDL"/>  
        <exec executable="${env.S1AS_HOME}/bin/wsimport">
            <arg line="-keep -b custom-client.xml -d ${env.APS_HOME}/build/module/classes http://${http.host}:${http.port}/WebServiceEJBService/WebServiceEJB?WSDL"/>
        </exec>
        <javac srcdir="." destdir="${env.APS_HOME}/build/module/classes"
            classpath="${env.S1AS_HOME}/lib/j2ee.jar:${env.S1AS_HOME}/lib/jaxrpc-impl.jar:${env.S1AS_HOME}/lib/jaxws-impl.jar"
            includes="ejb/HelloEJB.java"/>
        <jar destfile="${env.S1AS_HOME}/domains/domain1/autodeploy/EjbClient.jar"
	    basedir="${env.APS_HOME}/build/module/classes"
	    includes="ejb/**,endpoint/**"/>
	<waitfor maxwait="100" maxwaitunit="second">
       	    <or>
                <available file="${env.S1AS_HOME}/domains/domain1/autodeploy/EjbClient.jar_deployed"/>
                <available file="${env.S1AS_HOME}/domains/domain1/autodeploy/EjbClient.jar_deployFailed"/>
            </or>
        </waitfor>
        <condition property="deploy_succeeded">
            <available file="${env.S1AS_HOME}/domains/domain1/autodeploy/EjbClient.jar_deployed"/>
        </condition>
        <condition property="deploy_failed">
            <available file="${env.S1AS_HOME}/domains/domain1/autodeploy/EjbClient.jar_deployFailed"/>
        </condition>
	<fail if="deploy_failed" message="Deployment failed"/>
        <basename file="${client-src-name}" property="client" suffix=".java"/>
        <dirname file="${client-src-name}" property="client-directory"/>
        <basename file="${client-directory}" property="client-pkg-name"/> 
        <property name="client-class-name" value="${client-pkg-name}/${client}.class"/>
	<antcall target="compile-client"/>
        <echo message="Running appclient with ${client-pkg-name}.${client}"/>
        <unjar src="${env.APS_HOME}/lib/reporter.jar" dest="${env.APS_HOME}/build/module/classes"/>
        <exec executable="${env.S1AS_HOME}/bin/appclient" dir="${env.APS_HOME}/build/module/classes">
            <arg value="${client-pkg-name}.${client}"/>    
        </exec>
    </target>

    <target name="report-success">
            <echo message="Test PASSED"/>
    </target>

    <target name="report-failure">
            <echo message="Test FAILED"/>
    </target>   	
    
</project>
