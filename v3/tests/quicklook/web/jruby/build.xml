<?xml version="1.0" encoding="UTF-8"?>

<project name="jruby-hello" default="default" basedir=".">    
    <property file="build.properties"/>
    <property name="download.dir" value="${ws.root}/downloads/jruby"/>
 <description>Builds, tests, and runs the project Hello JSP Application</description>
<!-- <import file="nbproject/build-impl.xml"/>-->

<target name="build">    
    <echo message="======================================================="/>
    <echo message="JRuby Application..do nothing"/>
    <echo message="======================================================="/>
</target>


<target name="checkjRubyExists">
    <available property="present"
               file="${ws.root}/downloads/jruby/jruby.zip"/>
    <echo message="${ws.root}/jruby/jruby.zip exists: ${present}"/>
</target>

<target name="download-jruby" depends="checkjRubyExists">
    <echo message="downloading jruby.."/>
    <property name="jruby.version" value="1.0.3"/>
    <property name="jruby-zip" 
    value="http://dist.codehaus.org/jruby/jruby-bin-${jruby.version}.zip"/>
    <mkdir dir="${download.dir}"/>    
    <get src="${jruby-zip}"    
         dest="${download.dir}/jruby.zip" 
         verbose="true"
         usetimestamp="true"/>
    <antcall target="unzip-jruby"/>
</target>

<target name="install-jruby" depends="checkFileExists" if="present">
    <echo message="unzipping jruby 1.0.3.."/>
    <unzip src="${download.dir}/jruby.zip" dest="${ws.root}" overwrite="true"/>    
    <move file="${ws.root}/jruby-1.0.3" tofile="${ws.root}/jruby" overwrite="true"/>
    <copy todir="${glassfish.home}/modules" overwrite="true" failonerror="false">
        <fileset dir="${ws.root}/jruby"/>
    </copy>
    <echo message="JRUBY_HOME=${jruby.home}"
          file="${glassfish.home}/config/asenv.conf" append="true" osfamily="unix"/>
    <echo message="JRUBY_HOME=${jruby.home}"
          file="${glassfish.home}/config/asenv.bat" append="true" osfamily="windows"/>
    <antcall target="restart-server"/>
</target>

<target name="checkJRubyInstall">
    
    <available property="jExists"
               file="${jruby.home}/bin/jruby"/>
    <echo message="${jruby.home}/bin/jruby exists: ${jExists}"/>
</target>

<target name="install-gems" depends="checkJRubyInstall">      
    <echo message="Installing JRuby rails gem.."/>
    <chmod dir="${jruby.home}/bin" perm="ugo+x" includes="**/*"/>
    <echo message="jruby home is ${jruby.home}"/>
    <exec executable="cmd" osfamily="Windows">
        <arg value="/c"/>
        <arg line="${jruby.home}/bin/gem.bat"/>            
        <arg line="install rails --ver=${rails.version} --no-rdoc --no-ri --include-dependencies"/>    
    </exec>  
    
    <exec executable="${jruby.home}/bin/gem" failonerror="true" osfamily="unix">            
        <arg line=" install rails --ver=${rails.version} --no-rdoc --no-ri --include-dependencies"/>                        
    </exec>  
    
</target>

<target name="compile-tests"
            description="compile the test ng example" depends="">
       
       <mkdir dir="${test.class.output}"/>
       <javac   debug="true"
              fork="true"
              source="1.5"
              classpathref="path2testng"
              srcdir="helloapp/test"
              destdir="${test.class.output}"
       />
</target>

<target  name="run">      
    <echo message="=============Starting TestNG test at ${class.output}/test  ============"/>    
    <mkdir dir="${result.output}"/>
    <testng outputdir="${result.output}"
    suitename="V3 JRuby TestSuite"
    testname="web_jruby_hello"
            classpathref="run.testng.classpath">
        <!--<xmlfileset dir="../../" includes="testng.xml"/>-->
        <classfileset dir="${test.class.output}" includes="**/JRubyTestNG.class"/>
        <jvmarg value="-Dhost=${glassfish.http.host}" />
        <jvmarg value="-Dport=${glassfish.http.port}" />
        <jvmarg value="-Dcontextroot=helloapp" />
    </testng>
</target>

    
    <target name="restart-instance">      
    </target>
    
<!--<target name="set-jrubyhome-unix" if="isUnix">
  <echo message="OS is ${os.name}"/>
<concat destfile="${glassfish.home}/config/asenv.conf" append="true" >JRUBY_HOME=${JRUBY_HOME}
</concat>
  <exec executable="${glassfish.home}/bin/asadmin">
    <arg value="stop-domain"/>
  </exec>
  <exec executable="${glassfish.home}/bin/asadmin">
    <arg value="start-domain"/>
  </exec>
</target>

<target name="set-jrubyhome-win" if="isWindows">
<echo message="${glassfish.home}/config/asenv.bat"/>
<concat destfile="${glassfish.home}/config/asenv.bat" append="true" >set JRUBY_HOME=${JRUBY_HOME}
</concat>
  <exec executable="cmd">
    <arg value="/c"/>
    <arg value="${glassfish.home}/bin/asadmin.bat"/>
    <arg value="stop-domain"/>
  </exec>
  <exec executable="start">
    <arg value="${glassfish.home}/bin/asadmin.bat"/>
    <arg value="start-domain"/>
  </exec>
</target>-->
    
</project>
