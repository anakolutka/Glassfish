<project name="GlassFish Admin Console Dev Test Hudson Helper" default="start-server" basedir="."
         xmlns:artifact="antlib:org.apache.maven.artifact.ant">

    <property name="maven.version" value="apache-maven-2.0.11"/>
    <property name="BROWSER" value="firefox"/>

    <property name="install.dir" value="binaries"/>
    <property name="server.dir" value="${install.dir}/glassfishv3"/>
    <property name="maven.dir" value="${install.dir}/${maven.version}"/>

    <property environment="env"/>

    <property name="GUI_PORT" value="50001"/>
    <property name="GUI_ADMIN_PORT" value="50002"/>
    <property name="GUI_JMS_PORT" value="50003"/>
    <property name="GUI_JMX_PORT" value="50004"/>
    <property name="GUI_ORB_PORT" value="50005"/>
    <property name="GUI_SSL_PORT" value="50006"/>
    <property name="GUI_ORB_SSL_PORT" value="50007"/>
    <property name="GUI_ORB_SSL_MUTUALAUTH_PORT" value="50008"/>
    <property name="GUI_OSGI_SHELL" value="50009"/>

    <property name="glassfish.dist.url"
              value="http://gf-hudson.sfbay.sun.com/hudson/job/gf-trunk-build-continuous/lastSuccessfulBuild/artifact/bundles/glassfish.zip"/>

    <target name="download">
        <get src="http://mirrors.ibiblio.org/pub/mirrors/maven2/ant-contrib/ant-contrib/1.0b3/ant-contrib-1.0b3.jar"
             dest="ant-contrib.jar" usetimestamp="true"/>
        <get src="http://www.ibiblio.org/pub/mirrors/apache/maven/binaries/maven-ant-tasks-2.1.0.jar"
             dest="maven-ant-tasks.jar" usetimestamp="true"/>
        <get src="http://www.ibiblio.org/pub/mirrors/apache/maven/binaries/${maven.version}-bin.zip"
             dest="maven.zip" usetimestamp="true"/>
        <get src="${glassfish.dist.url}" dest="glassfish.zip" usetimestamp="true"/>

        <delete dir="${install.dir}"/>
        <mkdir dir="${install.dir}"/>
        <!--
        <get src="http://hudson.glassfish.org/job/gf-trunk-build-continuous/lastSuccessfulBuild/artifact/bundles/glassfish.zip" dest="glassfish.zip" usetimestamp="true"/>
        -->
        <unzip src="glassfish.zip" dest="${install.dir}"/>


        <!-- This just keeps getting uglier :| -->
        <unzip src="maven.zip" dest="${install.dir}/"/>
    </target>

    <target name="setup">
        <taskdef resource="net/sf/antcontrib/antlib.xml" classpath="ant-contrib.jar"/>
        <typedef resource="org/apache/maven/artifact/ant/antlib.xml" uri="antlib:org.apache.maven.artifact.ant"
                 classpath="maven-ant-tasks.jar"/>

        <if>
            <os family="windows"/>
            <then>
                <property name="executable" value="${server.dir}/bin/asadmin.bat"/>
            </then>
            <else>
                <property name="executable" value="${server.dir}/bin/asadmin"/>
                <chmod perm="u+x" file="${executable}"/>
            </else>
        </if>
    </target>

    <target name="start-server" depends="setup,shutdown-server">
        <exec executable="${executable}">
            <arg value="delete-domain"/>
            <arg value="domain1"/>
        </exec>

        <exec executable="${executable}">
            <arg value="create-domain"/>
            <arg value="--adminport"/>
            <arg value="${GUI_ADMIN_PORT}"/>
            <arg value="--nopassword=true"/>
            <arg value="--domainproperties"/>
            <arg value="jms.port=${GUI_JMS_PORT}:domain.jmxPort=${GUI_JMX_PORT}:orb.listener.port=${GUI_ORB_PORT}:http.ssl.port=${GUI_SSL_PORT}:orb.ssl.port=${GUI_ORB_SSL_PORT}:orb.mutualauth.port=${GUI_ORB_SSL_MUTUALAUTH_PORT}:osgi.shell.telnet.port=${GUI_OSGI_SHELL}"/>
            <arg value="--instanceport"/>
            <arg value="${GUI_PORT}"/>
            <arg value="domain1"/>
        </exec>

        <echo message="***** Starting GlassFish"/>
        <exec executable="${executable}">
            <arg value="start-domain"/>
        </exec>
    </target>

    <target name="test" depends="download,setup">
        <trycatch>
            <try>
                <antcall target="start-server"/>
                <artifact:mvn pom="pom.xml" fork="true" mavenHome="${maven.dir}" failonerror="false" resultproperty="test.result">
                    <arg value="-Dadmin.port=${GUI_ADMIN_PORT}"/>
                    <arg value="-Dbrowser=${BROWSER}"/>
                    <arg value="test"/>
                </artifact:mvn>
            </try>
            <finally>
                <antcall target="shutdown-server"/>
            </finally>
        </trycatch>
        <fail message="The test run failed.  Please see the console output for details.">
           <condition>
             <not>
                <equals arg1="${test.result}" arg2="0"/>
             </not>
           </condition>
         </fail>
    </target>

    <target name="shutdown-server" depends="setup">
        <echo message="***** Stopping GlassFish"/>
        <exec executable="${executable}">
            <arg value="stop-domain"/>
        </exec>
    </target>
</project>
