<!--
    BASIC SCENARIOS TARGETS
-->

<!--
    deployment: deploys the set of version, to process the tests the
    deployWithTest's param is required (true value)
-->
<target name="deployment">
    <!-- deploys the untagged version -->
    <antcall target="deploy.version">
        <param name="force" value="true"/>
    </antcall>
    <!-- test that the deployed version running is the untagged -->
    <antcall target="run.positive.deploy"/>
    
    <!-- deploys the ${identifier.1} -->
    <antcall target="deploy.version">
        <param name="force" value="true"/>
        <param name="identifier" value="${identifier.1}"/>
    </antcall>
    <!-- test that the deployed version running is ${identifier.1} -->
    <antcall target="run.positive.deploy">
        <param name="versionIdentifier" value="${identifier.1}"/>
    </antcall>

    <!-- deploys the ${identifier.2} -->
    <antcall target="deploy.version">
        <param name="enabled" value="false"/>
        <param name="force" value="true"/>
        <param name="identifier" value="${identifier.2}"/>
    </antcall>
    <!-- test that the deployed version running is ${identifier.1} -->
    <antcall target="run.positive.deploy">
        <param name="versionIdentifier" value="${identifier.1}"/>
    </antcall>

    <!-- deploys the ${identifier.3} -->
    <antcall target="deploy.version">
        <param name="enabled" value="false"/>
        <param name="force" value="true"/>
        <param name="identifier" value="${identifier.3}"/>
    </antcall>
    <!-- test that the deployed version running is ${identifier.1} -->
    <antcall target="run.positive.deploy">
        <param name="versionIdentifier" value="${identifier.1}"/>
    </antcall>

    <!-- deploys the ${identifier.4} -->
    <antcall target="deploydir.version">
        <param name="force" value="true"/>
        <param name="identifier" value="${identifier.4}"/>
    </antcall>
    <!-- test that the deployed version running is ${identifier.4} -->
    <antcall target="run.positive.deploy">
        <param name="versionIdentifier" value="${identifier.4}"/>
    </antcall>
</target>

<target name="undeployment" depends="deployment">
    <!-- undeploys the untagged version -->
    <antcall target="undeploy.version"/>
    <!-- test that the untagged version isn't registred -->
    <antcall target="test.notregistred">
        <param name="description" value="undeployment"/>
    </antcall>

    <!-- undeploys all the version -->
    <antcall target="undeploy.version">
        <param name="expression" value="${identifier.1}"/>
    </antcall>
    <!-- test that the version ${identifier.1} isn't registred -->
    <antcall target="test.notregistred">
        <param name="description" value="undeployment"/>
        <param name="identifier" value="${identifier.1}"/>
    </antcall>

    <!-- undeploys all the ${qualifier.1} version -->
    <antcall target="undeploy.version">
        <param name="expression" value="${qualifier.1}*"/>
    </antcall>
    <!-- test that the version ${identifier.2} isn't registred -->
    <antcall target="test.notregistred">
        <param name="description" value="undeployment"/>
        <param name="identifier" value="${identifier.2}"/>
    </antcall>

    <!-- undeploys all the versions -->
    <antcall target="undeploy.version">
        <param name="expression" value="*"/>
    </antcall>
    <!-- test that the version ${identifier.3} isn't registred -->
    <antcall target="test.notregistred">
        <param name="description" value="undeployment"/>
        <param name="identifier" value="${identifier.3}"/>
    </antcall>
</target>

<target name="deactivation" depends="deployment">
    <!-- disables the untagged version -->
    <antcall target="disable.version"/>
    <!-- test that the untagged version is disabled -->
    <antcall target="run.negative">
        <param name="description" value="deactivation"/>
    </antcall>

    <!-- disables the version ${identifier.1} -->
    <antcall target="disable.version">
        <param name="expression" value="${identifier.1}"/>
    </antcall>
    <!-- test that the version ${identifier.1} is disabled -->
    <antcall target="run.negative">
        <param name="description" value="deactivation"/>
        <param name="versionIdentifier" value="${identifier.1}"/>
    </antcall>

    <!-- disables all the ${qualifier.1} version(s) -->
    <antcall target="disable.version">
        <param name="expression" value="${qualifier.1}*"/>
    </antcall>
    <!-- test that the version ${identifier.1} is disabled -->
    <antcall target="run.negative">
        <param name="description" value="deactivation"/>
        <param name="versionIdentifier" value="${identifier.1}"/>
    </antcall>

    <!-- enables the version ${identifier.3} for the test -->
    <!-- disables all the versions -->
    <antcall target="disable.version">
        <param name="expression" value="*"/>
    </antcall>
    <!-- test that the version ${identifier.3} isn't registred -->
    <antcall target="run.negative">
        <param name="description" value="deactivation"/>
        <param name="versionIdentifier" value="${identifier.3}"/>
    </antcall>
</target>

<!-- enable.version.set: enables each version of the version set -->
<target name="switch" depends="deployment">
    <!-- enables the untagged version -->
    <antcall target="enable.version"/>
    <!-- test that the untagged version is enabled  -->
    <antcall target="run.positive">
        <param name="description" value="switch"/>
    </antcall>

    <!-- enables the ${identifier.1} -->
    <antcall target="enable.version">
        <param name="identifier" value="${identifier.1}"/>
    </antcall>
    <!-- test that the the ${identifier.1} version is enabled  -->
    <antcall target="run.positive">
        <param name="description" value="switch"/>
        <param name="versionIdentifier" value="${identifier.1}"/>
    </antcall>

    <!-- enables the ${identifier.2} -->
    <antcall target="enable.version">
        <param name="identifier" value="${identifier.2}"/>
    </antcall>
    <!-- test that the the ${identifier.2} version is enabled  -->
    <antcall target="run.positive">
        <param name="description" value="switch"/>
        <param name="versionIdentifier" value="${identifier.2}"/>
    </antcall>

    <!-- enables the ${identifier.3} -->
    <antcall target="enable.version">
        <param name="identifier" value="${identifier.3}"/>
    </antcall>
    <!-- test that the ${identifier.3} version is enabled  -->
    <antcall target="run.positive">
        <param name="description" value="switch"/>
        <param name="versionIdentifier" value="${identifier.3}"/>
    </antcall>

    <!-- enables the ${identifier.4} -->
    <antcall target="enable.version">
        <param name="identifier" value="${identifier.4}"/>
    </antcall>
    <!-- test that the the ${identifier.4} version is enabled  -->
    <antcall target="run.positive">
        <param name="description" value="switch"/>
        <param name="versionIdentifier" value="${identifier.4}"/>
    </antcall>
</target>

<target name="redeployment">
    <antcall target="clean.scenario"/>
    <!-- redeployment scenario of the untagged version -->
    <!-- deploys the untagged version -->
    <antcall target="deploy.version"/>
    <!-- redeploys using redeploy command -->
    <antcall target="redeploy.version"/>
    <!-- test that the deployed version running is the untagged -->
    <antcall target="run.positive">
        <param name="description" value="redeployment"/>
    </antcall>
    <!-- deploys the untagged version with force=true -->
    <antcall target="deploy.version">
        <param name="force" value="true"/>
    </antcall>
    <!-- test that the deployed version running is the untagged -->
    <antcall target="run.positive">
        <param name="description" value="redeployment"/>
    </antcall>

    <!-- redeployment scenario of the ${identifier.1} version -->
    <!-- deploys the untagged version -->
    <antcall target="deploy.version">
        <param name="identifier" value="${identifier.1}"/>
    </antcall>
    <!-- redeploys using redeploy command -->
    <antcall target="redeploy.version">
        <param name="identifier" value="${identifier.1}"/>
    </antcall>
    <!-- test that the deployed version running is the ${identifier.1} -->
    <antcall target="run.positive">
        <param name="description" value="redeployment"/>
        <param name="versionIdentifier" value="${identifier.1}"/>
    </antcall>
    <!-- deploys the ${identifier.1} version with force=true -->
    <antcall target="deploy.version">
        <param name="force" value="true"/>
        <param name="identifier" value="${identifier.1}"/>
    </antcall>
    <!-- test that the deployed version running is the ${identifier.1} -->
    <antcall target="run.positive">
        <param name="description" value="redeployment"/>
        <param name="versionIdentifier" value="${identifier.1}"/>
    </antcall>
</target>

<target name="versioned.vs.unversioned">
    <antcall target="clean.scenario"/>
    <!-- deploys an untagged version in v2 style -->
    <antcall target="deploy.v2">
        <param name="applicationName" value="${untaggedName}"/>
    </antcall>
    <!-- test that the deployed version running is the untagged version -->
    <antcall target="run.positive">
        <param name="description" value="versioned.vs.unversioned"/>
    </antcall>
    <!-- disable the untagged version -->
    <antcall target="disable.version"/>
     <!-- test that the deployed version running is not the untagged version -->
    <antcall target="run.negative">
        <param name="description" value="versioned.vs.unversioned"/>
    </antcall>
    <!-- deploys the ${identifier.1} version -->
    <antcall target="deploy.version">
        <param name="identifier" value="${identifier.1}"/>
    </antcall>
    <!-- test that the deployed version running is the ${identifier.1} -->
    <antcall target="run.positive">
        <param name="description" value="versioned.vs.unversioned"/>
        <param name="versionIdentifier" value="${identifier.1}"/>
    </antcall>
</target>

<target name="client-stubs">
    <antcall target="clean.scenario"/>
    <!-- deploys an untagged version and retrieve the stubs -->
    <antcall target="deploy.version"/>
    <antcall target="get-client-stubs.asadmin">
        <param name="appName" value="${untaggedName}"/>
        <param name="stubsPath" value="."/>
    </antcall>

    <!-- deploys a specific version and retrieve the stubs -->
    <antcall target="deploy.version">
        <param name="identifier" value="${identifier.1}"/>
    </antcall>

    <antcall target="get-client-stubs.asadmin">
        <param name="appName" value="${untaggedName}:${identifier.1}"/>
        <param name="stubsPath" value="."/>
    </antcall>
</target>
<target name="samples.scenarios">
    <antcall target="clean.scenario"/>
    <!-- deploys an untagged version -->
    <antcall target="deploy.version"/>
    <antcall target="run.positive">
        <param name="description" value="sample.scenarios"/>
    </antcall>
    <!-- deploys the same version, but has to force -->
    <antcall target="deploy.version">
        <param name="force" value="true"/>
    </antcall>
    <antcall target="run.positive">
        <param name="description" value="sample.scenarios"/>
    </antcall>
    <!-- deploys a specific version -->
    <antcall target="deploy.version">
        <param name="identifier" value="${identifier.1}"/>
    </antcall>
    <antcall target="run.positive">
        <param name="description" value="sample.scenarios"/>
        <param name="versionIdentifier" value="${identifier.1}"/>
    </antcall>
    <!-- deploys a specific version in a disable state -->
    <antcall target="deploy.version">
        <param name="identifier" value="${identifier.2}"/>
        <param name="enabled" value="false"/>
    </antcall>
    <antcall target="run.negative">
        <param name="description" value="sample.scenarios"/>
        <param name="versionIdentifier" value="${identifier.2}"/>
    </antcall>

    <!-- enables the previously deployed version ${identifier.2} -->
    <antcall target="enable.version">
        <param name="identifier" value="${identifier.2}"/>
    </antcall>
    <antcall target="run.positive">
        <param name="description" value="sample.scenarios"/>
        <param name="versionIdentifier" value="${identifier.2}"/>
    </antcall>
    <!-- deploys a new specific version (enable state) -->
    <antcall target="deploy.version">
        <param name="identifier" value="${identifier.3}"/>
    </antcall>
    <antcall target="run.positive">
        <param name="description" value="sample.scenarios"/>
        <param name="versionIdentifier" value="${identifier.3}"/>
    </antcall>
    <!-- undeploys all the version qualified by ${qualifier.1} -->
    <antcall target="undeploy.version">
        <param name="expression" value="${qualifier.1}*"/>
    </antcall>
    <!--
        test that version ${identifier.2} isn't registred because
        it's qualified by ${qualifier.1}, see build.properties
    -->
    <antcall target="test.notregistred">
        <param name="identifier" value="${identifier.2}"/>
        <param name="description" value="sample.scenarios"/>
    </antcall>
    <!-- switch to the untagged version -->
    <antcall target="enable.version"/>
    <antcall target="run.positive">
        <param name="description" value="sample.scenarions"/>
    </antcall>
    <!-- undeploys all the versions -->
    <antcall target="undeploy.version">
        <param name="expression" value="*"/>
    </antcall>
    <antcall target="test.notregistred">
        <param name="description" value="sample.scenarios"/>
        <param name="identifier" value="${identifier.3}"/>
    </antcall>
    <antcall target="test.notregistred">
        <param name="description" value="sample.scenarios"/>
    </antcall>
</target>
